# ============================================================================
# 台灣交通事故分析 - 完整版 (數據清理 + 空間分析)
# ============================================================================
library(tidyverse)
library(stringr)
library(ggplot2)
library(leaflet)
library(htmlwidgets)
library(cluster)
library(factoextra)
library(viridis)
library(scales)
library(RColorBrewer)

# ============================================================================
# PART 1: 讀取原始數據
# ============================================================================

cat("PART 1: 讀取原始數據\n")

traffic_data <- read.csv("E:/碩一/consulation/final data/traffic_accident_102_110.csv")

cat("原始數據:", nrow(traffic_data), "筆,", ncol(traffic_data), "欄\n")

# 篩選年份 2013-2019
traffic_data <- traffic_data %>%
  filter(ad_year >= 2013 & ad_year <= 2019)

cat("篩選後 (2013-2019):", nrow(traffic_data), "筆\n")

# 查看發生地點範例
cat("\n【發生地點範例】\n")
print(head(traffic_data$發生地點, 10))

# ============================================================================
# PART 2: 建立完整座標表 (368個鄉鎮市區)
# ============================================================================

cat("PART 2: 建立座標表 (368個鄉鎮市區)\n")

taiwan_district_coords <- tribble(
  ~county, ~district, ~lat, ~lng,
  # ========== 台北市 (12區) ==========
  "臺北市", "中正區", 25.0324, 121.5199,
  "臺北市", "大同區", 25.0634, 121.5130,
  "臺北市", "中山區", 25.0645, 121.5266,
  "臺北市", "松山區", 25.0499, 121.5576,
  "臺北市", "大安區", 25.0266, 121.5437,
  "臺北市", "萬華區", 25.0340, 121.4997,
  "臺北市", "信義區", 25.0329, 121.5679,
  "臺北市", "士林區", 25.0927, 121.5249,
  "臺北市", "北投區", 25.1321, 121.5016,
  "臺北市", "內湖區", 25.0837, 121.5883,
  "臺北市", "南港區", 25.0550, 121.6176,
  "臺北市", "文山區", 24.9894, 121.5703,
  
  # ========== 新北市 (29區) ==========
  "新北市", "板橋區", 25.0145, 121.4593,
  "新北市", "三重區", 25.0615, 121.4872,
  "新北市", "中和區", 24.9991, 121.4989,
  "新北市", "永和區", 25.0076, 121.5143,
  "新北市", "新莊區", 25.0360, 121.4505,
  "新北市", "新店區", 24.9675, 121.5418,
  "新北市", "土城區", 24.9723, 121.4434,
  "新北市", "蘆洲區", 25.0847, 121.4715,
  "新北市", "樹林區", 24.9907, 121.4207,
  "新北市", "汐止區", 25.0676, 121.6633,
  "新北市", "鶯歌區", 24.9551, 121.3548,
  "新北市", "三峽區", 24.9342, 121.3688,
  "新北市", "淡水區", 25.1695, 121.4408,
  "新北市", "瑞芳區", 25.1089, 121.8068,
  "新北市", "五股區", 25.0823, 121.4339,
  "新北市", "泰山區", 25.0590, 121.4313,
  "新北市", "林口區", 25.0775, 121.3912,
  "新北市", "深坑區", 25.0022, 121.6154,
  "新北市", "石碇區", 24.9916, 121.6589,
  "新北市", "坪林區", 24.9375, 121.7114,
  "新北市", "三芝區", 25.2580, 121.5006,
  "新北市", "石門區", 25.2904, 121.5680,
  "新北市", "八里區", 25.1467, 121.4012,
  "新北市", "平溪區", 25.0258, 121.7382,
  "新北市", "雙溪區", 25.0334, 121.8655,
  "新北市", "貢寮區", 25.0227, 121.9082,
  "新北市", "金山區", 25.2220, 121.6365,
  "新北市", "萬里區", 25.1795, 121.6889,
  "新北市", "烏來區", 24.8654, 121.5505,
  
  # ========== 桃園市 (13區) ==========
  "桃園市", "桃園區", 24.9936, 121.3009,
  "桃園市", "中壢區", 24.9656, 121.2249,
  "桃園市", "平鎮區", 24.9459, 121.2185,
  "桃園市", "八德區", 24.9285, 121.2922,
  "桃園市", "楊梅區", 24.9074, 121.1466,
  "桃園市", "蘆竹區", 25.0455, 121.2824,
  "桃園市", "龜山區", 25.0277, 121.3441,
  "桃園市", "大溪區", 24.8806, 121.2866,
  "桃園市", "大園區", 25.0644, 121.1960,
  "桃園市", "觀音區", 25.0337, 121.1007,
  "桃園市", "新屋區", 24.9721, 121.1067,
  "桃園市", "龍潭區", 24.8636, 121.2163,
  "桃園市", "復興區", 24.8209, 121.3527,
  
  # ========== 台中市 (29區) ==========
  "臺中市", "中區", 24.1418, 120.6802,
  "臺中市", "東區", 24.1369, 120.6946,
  "臺中市", "南區", 24.1223, 120.6689,
  "臺中市", "西區", 24.1410, 120.6633,
  "臺中市", "北區", 24.1558, 120.6819,
  "臺中市", "北屯區", 24.1822, 120.7037,
  "臺中市", "西屯區", 24.1812, 120.6396,
  "臺中市", "南屯區", 24.1384, 120.6405,
  "臺中市", "太平區", 24.1265, 120.7194,
  "臺中市", "大里區", 24.0996, 120.6799,
  "臺中市", "霧峰區", 24.0617, 120.7353,
  "臺中市", "烏日區", 24.1079, 120.6213,
  "臺中市", "豐原區", 24.2543, 120.7186,
  "臺中市", "后里區", 24.3048, 120.7106,
  "臺中市", "石岡區", 24.2748, 120.7806,
  "臺中市", "東勢區", 24.2588, 120.8277,
  "臺中市", "和平區", 24.1749, 121.0118,
  "臺中市", "新社區", 24.2334, 120.8101,
  "臺中市", "潭子區", 24.2092, 120.7049,
  "臺中市", "大雅區", 24.2291, 120.6480,
  "臺中市", "神岡區", 24.2576, 120.6618,
  "臺中市", "大肚區", 24.1537, 120.5407,
  "臺中市", "沙鹿區", 24.2331, 120.5656,
  "臺中市", "龍井區", 24.1920, 120.5459,
  "臺中市", "梧棲區", 24.2549, 120.5317,
  "臺中市", "清水區", 24.2687, 120.5595,
  "臺中市", "大甲區", 24.3487, 120.6224,
  "臺中市", "外埔區", 24.3321, 120.6544,
  "臺中市", "大安區", 24.3461, 120.5861,
  
  # ========== 台南市 (37區) ==========
  "臺南市", "中西區", 22.9917, 120.2041,
  "臺南市", "東區", 22.9818, 120.2242,
  "臺南市", "南區", 22.9617, 120.1941,
  "臺南市", "北區", 23.0006, 120.2094,
  "臺南市", "安平區", 22.9967, 120.1630,
  "臺南市", "安南區", 23.0471, 120.1847,
  "臺南市", "永康區", 23.0264, 120.2537,
  "臺南市", "歸仁區", 22.9674, 120.2653,
  "臺南市", "新化區", 23.0385, 120.3104,
  "臺南市", "左鎮區", 23.0580, 120.4035,
  "臺南市", "玉井區", 23.1216, 120.4644,
  "臺南市", "楠西區", 23.1864, 120.4858,
  "臺南市", "南化區", 23.1350, 120.4821,
  "臺南市", "仁德區", 22.9722, 120.2331,
  "臺南市", "關廟區", 22.9618, 120.3277,
  "臺南市", "龍崎區", 22.9619, 120.3867,
  "臺南市", "官田區", 23.1946, 120.3141,
  "臺南市", "麻豆區", 23.1818, 120.2482,
  "臺南市", "佳里區", 23.1651, 120.1770,
  "臺南市", "西港區", 23.1234, 120.2035,
  "臺南市", "七股區", 23.1407, 120.1306,
  "臺南市", "將軍區", 23.2000, 120.0960,
  "臺南市", "學甲區", 23.2323, 120.1802,
  "臺南市", "北門區", 23.2675, 120.1258,
  "臺南市", "新營區", 23.3103, 120.3166,
  "臺南市", "後壁區", 23.3664, 120.3626,
  "臺南市", "白河區", 23.3511, 120.4157,
  "臺南市", "東山區", 23.3263, 120.4039,
  "臺南市", "六甲區", 23.2323, 120.3479,
  "臺南市", "下營區", 23.2354, 120.2648,
  "臺南市", "柳營區", 23.2782, 120.3118,
  "臺南市", "鹽水區", 23.3200, 120.2663,
  "臺南市", "善化區", 23.1323, 120.2967,
  "臺南市", "大內區", 23.1195, 120.3502,
  "臺南市", "山上區", 23.1031, 120.3525,
  "臺南市", "新市區", 23.0795, 120.2956,
  "臺南市", "安定區", 23.0851, 120.2325,
  
  # ========== 高雄市 (38區) ==========
  "高雄市", "楠梓區", 22.7285, 120.3260,
  "高雄市", "左營區", 22.6870, 120.2944,
  "高雄市", "鼓山區", 22.6365, 120.2716,
  "高雄市", "三民區", 22.6476, 120.3067,
  "高雄市", "鹽埕區", 22.6232, 120.2816,
  "高雄市", "前金區", 22.6266, 120.2902,
  "高雄市", "新興區", 22.6306, 120.3025,
  "高雄市", "苓雅區", 22.6203, 120.3103,
  "高雄市", "前鎮區", 22.6010, 120.3262,
  "高雄市", "小港區", 22.5512, 120.3556,
  "高雄市", "旗津區", 22.5879, 120.2851,
  "高雄市", "鳳山區", 22.6269, 120.3591,
  "高雄市", "大寮區", 22.5915, 120.3956,
  "高雄市", "鳥松區", 22.6548, 120.3627,
  "高雄市", "林園區", 22.5017, 120.4098,
  "高雄市", "仁武區", 22.7020, 120.3476,
  "高雄市", "大樹區", 22.6951, 120.4332,
  "高雄市", "大社區", 22.7293, 120.3524,
  "高雄市", "岡山區", 22.7967, 120.2953,
  "高雄市", "路竹區", 22.8562, 120.2617,
  "高雄市", "橋頭區", 22.7573, 120.3054,
  "高雄市", "梓官區", 22.7642, 120.2510,
  "高雄市", "彌陀區", 22.7825, 120.2474,
  "高雄市", "永安區", 22.8179, 120.2317,
  "高雄市", "燕巢區", 22.7935, 120.3612,
  "高雄市", "田寮區", 22.8697, 120.3575,
  "高雄市", "阿蓮區", 22.8821, 120.3268,
  "高雄市", "茄萣區", 22.9063, 120.1927,
  "高雄市", "湖內區", 22.9041, 120.2125,
  "高雄市", "旗山區", 22.8888, 120.4833,
  "高雄市", "美濃區", 22.8976, 120.5417,
  "高雄市", "六龜區", 22.9976, 120.6333,
  "高雄市", "甲仙區", 23.0841, 120.5904,
  "高雄市", "杉林區", 22.9712, 120.5387,
  "高雄市", "內門區", 22.9438, 120.4623,
  "高雄市", "茂林區", 22.8867, 120.6627,
  "高雄市", "桃源區", 23.1592, 120.7578,
  "高雄市", "那瑪夏區", 23.2709, 120.7028,
  
  # ========== 基隆市 (7區) ==========
  "基隆市", "中正區", 25.1467, 121.7778,
  "基隆市", "七堵區", 25.0958, 121.7131,
  "基隆市", "暖暖區", 25.1000, 121.7378,
  "基隆市", "仁愛區", 25.1271, 121.7417,
  "基隆市", "中山區", 25.1502, 121.7328,
  "基隆市", "安樂區", 25.1268, 121.7138,
  "基隆市", "信義區", 25.1255, 121.7578,
  
  # ========== 新竹市 (3區) ==========
  "新竹市", "東區", 24.8017, 120.9765,
  "新竹市", "北區", 24.8168, 120.9617,
  "新竹市", "香山區", 24.7695, 120.9278,
  
  # ========== 新竹縣 (13鄉鎮市) ==========
  "新竹縣", "竹北市", 24.8396, 121.0042,
  "新竹縣", "竹東鎮", 24.7333, 121.0861,
  "新竹縣", "新埔鎮", 24.8263, 121.0728,
  "新竹縣", "關西鎮", 24.7889, 121.1772,
  "新竹縣", "湖口鄉", 24.9023, 121.0440,
  "新竹縣", "新豐鄉", 24.9042, 120.9869,
  "新竹縣", "芎林鄉", 24.7666, 121.0762,
  "新竹縣", "橫山鄉", 24.7210, 121.1168,
  "新竹縣", "北埔鄉", 24.6971, 121.0530,
  "新竹縣", "寶山鄉", 24.7601, 120.9972,
  "新竹縣", "峨眉鄉", 24.6868, 121.0155,
  "新竹縣", "尖石鄉", 24.7043, 121.1980,
  "新竹縣", "五峰鄉", 24.6318, 121.1198,
  
  # ========== 苗栗縣 (18鄉鎮市) ==========
  "苗栗縣", "苗栗市", 24.5602, 120.8214,
  "苗栗縣", "頭份市", 24.6879, 120.9038,
  "苗栗縣", "竹南鎮", 24.6850, 120.8752,
  "苗栗縣", "後龍鎮", 24.6268, 120.7867,
  "苗栗縣", "通霄鎮", 24.4897, 120.6768,
  "苗栗縣", "苑裡鎮", 24.4423, 120.6531,
  "苗栗縣", "卓蘭鎮", 24.3119, 120.8244,
  "苗栗縣", "造橋鄉", 24.6379, 120.8607,
  "苗栗縣", "西湖鄉", 24.5587, 120.7498,
  "苗栗縣", "頭屋鄉", 24.5752, 120.8506,
  "苗栗縣", "公館鄉", 24.4998, 120.8229,
  "苗栗縣", "銅鑼鄉", 24.4859, 120.7858,
  "苗栗縣", "三義鄉", 24.4069, 120.7420,
  "苗栗縣", "大湖鄉", 24.4214, 120.8615,
  "苗栗縣", "獅潭鄉", 24.5407, 120.9172,
  "苗栗縣", "三灣鄉", 24.6517, 120.9517,
  "苗栗縣", "南庄鄉", 24.5967, 121.0025,
  "苗栗縣", "泰安鄉", 24.4426, 120.9103,
  
  # ========== 彰化縣 (26鄉鎮市) ==========
  "彰化縣", "彰化市", 24.0752, 120.5417,
  "彰化縣", "員林市", 23.9583, 120.5706,
  "彰化縣", "鹿港鎮", 24.0561, 120.4326,
  "彰化縣", "和美鎮", 24.1111, 120.5006,
  "彰化縣", "北斗鎮", 23.8711, 120.5200,
  "彰化縣", "溪湖鎮", 23.9622, 120.4789,
  "彰化縣", "田中鎮", 23.8617, 120.5800,
  "彰化縣", "二林鎮", 23.8989, 120.3739,
  "彰化縣", "線西鄉", 24.1286, 120.4678,
  "彰化縣", "伸港鄉", 24.1461, 120.4847,
  "彰化縣", "福興鄉", 24.0378, 120.4394,
  "彰化縣", "秀水鄉", 24.0361, 120.5036,
  "彰化縣", "花壇鄉", 24.0286, 120.5378,
  "彰化縣", "芬園鄉", 24.0117, 120.5808,
  "彰化縣", "大村鄉", 23.9958, 120.5461,
  "彰化縣", "埔鹽鄉", 24.0006, 120.4614,
  "彰化縣", "埔心鄉", 23.9525, 120.5233,
  "彰化縣", "永靖鄉", 23.9258, 120.5478,
  "彰化縣", "社頭鄉", 23.8961, 120.5825,
  "彰化縣", "二水鄉", 23.8103, 120.6178,
  "彰化縣", "田尾鄉", 23.8900, 120.5256,
  "彰化縣", "埤頭鄉", 23.8867, 120.4617,
  "彰化縣", "芳苑鄉", 23.9239, 120.3200,
  "彰化縣", "大城鄉", 23.8522, 120.3206,
  "彰化縣", "竹塘鄉", 23.8606, 120.4278,
  "彰化縣", "溪州鄉", 23.8503, 120.4983,
  
  # ========== 南投縣 (13鄉鎮市) ==========
  "南投縣", "南投市", 23.9094, 120.6836,
  "南投縣", "埔里鎮", 23.9644, 120.9681,
  "南投縣", "草屯鎮", 23.9742, 120.6842,
  "南投縣", "竹山鎮", 23.7579, 120.6719,
  "南投縣", "集集鎮", 23.8286, 120.7836,
  "南投縣", "名間鄉", 23.8383, 120.7028,
  "南投縣", "鹿谷鄉", 23.7511, 120.7528,
  "南投縣", "中寮鄉", 23.8792, 120.7628,
  "南投縣", "魚池鄉", 23.8961, 120.9356,
  "南投縣", "國姓鄉", 24.0406, 120.8581,
  "南投縣", "水里鄉", 23.8119, 120.8550,
  "南投縣", "信義鄉", 23.7100, 120.8550,
  "南投縣", "仁愛鄉", 24.0244, 121.1331,
  
  # ========== 雲林縣 (20鄉鎮市) ==========
  "雲林縣", "斗六市", 23.7075, 120.5272,
  "雲林縣", "斗南鎮", 23.6792, 120.4761,
  "雲林縣", "虎尾鎮", 23.7086, 120.4356,
  "雲林縣", "西螺鎮", 23.7978, 120.4661,
  "雲林縣", "土庫鎮", 23.6775, 120.3928,
  "雲林縣", "北港鎮", 23.5700, 120.3022,
  "雲林縣", "古坑鄉", 23.6422, 120.5617,
  "雲林縣", "大埤鄉", 23.6458, 120.4300,
  "雲林縣", "莿桐鄉", 23.7608, 120.5011,
  "雲林縣", "林內鄉", 23.7578, 120.6106,
  "雲林縣", "二崙鄉", 23.7864, 120.4144,
  "雲林縣", "崙背鄉", 23.7589, 120.3539,
  "雲林縣", "麥寮鄉", 23.7550, 120.2533,
  "雲林縣", "東勢鄉", 23.6753, 120.2506,
  "雲林縣", "褒忠鄉", 23.6942, 120.3089,
  "雲林縣", "台西鄉", 23.7025, 120.1978,
  "雲林縣", "元長鄉", 23.6494, 120.3153,
  "雲林縣", "四湖鄉", 23.6367, 120.2256,
  "雲林縣", "口湖鄉", 23.5817, 120.1839,
  "雲林縣", "水林鄉", 23.5661, 120.2461,
  
  # ========== 嘉義市 (2區) ==========
  "嘉義市", "東區", 23.4866, 120.4628,
  "嘉義市", "西區", 23.4733, 120.4289,
  
  # ========== 嘉義縣 (18鄉鎮市) ==========
  "嘉義縣", "太保市", 23.4594, 120.3328,
  "嘉義縣", "朴子市", 23.4650, 120.2472,
  "嘉義縣", "布袋鎮", 23.3775, 120.1656,
  "嘉義縣", "大林鎮", 23.6033, 120.4700,
  "嘉義縣", "民雄鄉", 23.5511, 120.4272,
  "嘉義縣", "溪口鄉", 23.6025, 120.3922,
  "嘉義縣", "新港鄉", 23.5517, 120.3472,
  "嘉義縣", "六腳鄉", 23.4933, 120.2917,
  "嘉義縣", "東石鄉", 23.4583, 120.1533,
  "嘉義縣", "義竹鄉", 23.3367, 120.2256,
  "嘉義縣", "鹿草鄉", 23.4106, 120.3078,
  "嘉義縣", "水上鄉", 23.4283, 120.3978,
  "嘉義縣", "中埔鄉", 23.4256, 120.5228,
  "嘉義縣", "竹崎鄉", 23.5244, 120.5506,
  "嘉義縣", "梅山鄉", 23.5867, 120.5556,
  "嘉義縣", "番路鄉", 23.4683, 120.5578,
  "嘉義縣", "大埔鄉", 23.2967, 120.5922,
  "嘉義縣", "阿里山鄉", 23.4678, 120.7400,
  
  # ========== 屏東縣 (33鄉鎮市) ==========
  "屏東縣", "屏東市", 22.6692, 120.4886,
  "屏東縣", "潮州鎮", 22.5500, 120.5422,
  "屏東縣", "東港鎮", 22.4656, 120.4544,
  "屏東縣", "恆春鎮", 22.0028, 120.7467,
  "屏東縣", "萬丹鄉", 22.5892, 120.4856,
  "屏東縣", "長治鄉", 22.6792, 120.5294,
  "屏東縣", "麟洛鄉", 22.6508, 120.5258,
  "屏東縣", "九如鄉", 22.7350, 120.4869,
  "屏東縣", "里港鄉", 22.7783, 120.4961,
  "屏東縣", "鹽埔鄉", 22.7533, 120.5272,
  "屏東縣", "高樹鄉", 22.8250, 120.5967,
  "屏東縣", "萬巒鄉", 22.5717, 120.5711,
  "屏東縣", "內埔鄉", 22.6133, 120.5656,
  "屏東縣", "竹田鄉", 22.5850, 120.5439,
  "屏東縣", "新埤鄉", 22.4694, 120.5500,
  "屏東縣", "枋寮鄉", 22.3656, 120.5944,
  "屏東縣", "新園鄉", 22.5372, 120.4606,
  "屏東縣", "崁頂鄉", 22.5144, 120.5089,
  "屏東縣", "林邊鄉", 22.4333, 120.5117,
  "屏東縣", "南州鄉", 22.4828, 120.5117,
  "屏東縣", "佳冬鄉", 22.4189, 120.5533,
  "屏東縣", "琉球鄉", 22.3433, 120.3717,
  "屏東縣", "車城鄉", 22.0733, 120.7117,
  "屏東縣", "滿州鄉", 22.0211, 120.8378,
  "屏東縣", "枋山鄉", 22.2606, 120.6550,
  "屏東縣", "三地門鄉", 22.7133, 120.6533,
  "屏東縣", "霧臺鄉", 22.7467, 120.7333,
  "屏東縣", "瑪家鄉", 22.7067, 120.6567,
  "屏東縣", "泰武鄉", 22.6000, 120.6333,
  "屏東縣", "來義鄉", 22.5267, 120.6333,
  "屏東縣", "春日鄉", 22.3733, 120.6300,
  "屏東縣", "獅子鄉", 22.2200, 120.7067,
  "屏東縣", "牡丹鄉", 22.1267, 120.7700,
  
  # ========== 宜蘭縣 (12鄉鎮市) ==========
  "宜蘭縣", "宜蘭市", 24.7521, 121.7578,
  "宜蘭縣", "羅東鎮", 24.6772, 121.7700,
  "宜蘭縣", "蘇澳鎮", 24.5947, 121.8428,
  "宜蘭縣", "頭城鎮", 24.8592, 121.8231,
  "宜蘭縣", "礁溪鄉", 24.8267, 121.7667,
  "宜蘭縣", "壯圍鄉", 24.7500, 121.7867,
  "宜蘭縣", "員山鄉", 24.7433, 121.7217,
  "宜蘭縣", "冬山鄉", 24.6350, 121.7933,
  "宜蘭縣", "五結鄉", 24.6833, 121.7983,
  "宜蘭縣", "三星鄉", 24.6650, 121.6650,
  "宜蘭縣", "大同鄉", 24.6767, 121.5017,
  "宜蘭縣", "南澳鄉", 24.4650, 121.8017,
  
  # ========== 花蓮縣 (13鄉鎮市) ==========
  "花蓮縣", "花蓮市", 23.9910, 121.6011,
  "花蓮縣", "鳳林鎮", 23.7453, 121.4519,
  "花蓮縣", "玉里鎮", 23.3364, 121.3136,
  "花蓮縣", "新城鄉", 24.1283, 121.6517,
  "花蓮縣", "吉安鄉", 23.9617, 121.5683,
  "花蓮縣", "壽豐鄉", 23.8700, 121.5117,
  "花蓮縣", "光復鄉", 23.6700, 121.4233,
  "花蓮縣", "豐濱鄉", 23.5983, 121.5183,
  "花蓮縣", "瑞穗鄉", 23.4967, 121.3783,
  "花蓮縣", "富里鄉", 23.1800, 121.2517,
  "花蓮縣", "秀林鄉", 24.1317, 121.5317,
  "花蓮縣", "萬榮鄉", 23.7117, 121.4017,
  "花蓮縣", "卓溪鄉", 23.3467, 121.3017,
  
  # ========== 台東縣 (16鄉鎮市) ==========
  "臺東縣", "臺東市", 22.7583, 121.1444,
  "臺東縣", "成功鎮", 23.1017, 121.3783,
  "臺東縣", "關山鎮", 23.0483, 121.1633,
  "臺東縣", "卑南鄉", 22.7867, 121.0833,
  "臺東縣", "大武鄉", 22.3550, 120.8883,
  "臺東縣", "太麻里鄉", 22.6150, 121.0067,
  "臺東縣", "東河鄉", 22.9700, 121.3017,
  "臺東縣", "長濱鄉", 23.3150, 121.4517,
  "臺東縣", "鹿野鄉", 22.9133, 121.1350,
  "臺東縣", "池上鄉", 23.1233, 121.2150,
  "臺東縣", "綠島鄉", 22.6617, 121.4867,
  "臺東縣", "延平鄉", 22.9017, 121.0833,
  "臺東縣", "海端鄉", 23.1000, 121.1717,
  "臺東縣", "達仁鄉", 22.2950, 120.8783,
  "臺東縣", "金峰鄉", 22.5933, 120.9717,
  "臺東縣", "蘭嶼鄉", 22.0517, 121.5483,
  
  # ========== 澎湖縣 (6鄉市) ==========
  "澎湖縣", "馬公市", 23.5654, 119.5667,
  "澎湖縣", "湖西鄉", 23.5833, 119.6517,
  "澎湖縣", "白沙鄉", 23.6667, 119.6000,
  "澎湖縣", "西嶼鄉", 23.6000, 119.5167,
  "澎湖縣", "望安鄉", 23.3667, 119.5000,
  "澎湖縣", "七美鄉", 23.2000, 119.4333,
  
  # ========== 金門縣 (6鄉鎮) ==========
  "金門縣", "金城鎮", 24.4167, 118.3167,
  "金門縣", "金湖鎮", 24.4333, 118.4000,
  "金門縣", "金沙鎮", 24.4667, 118.4000,
  "金門縣", "金寧鄉", 24.4500, 118.3333,
  "金門縣", "烈嶼鄉", 24.4333, 118.2500,
  "金門縣", "烏坵鄉", 24.9833, 119.4500,
  
  # ========== 連江縣 (4鄉) ==========
  "連江縣", "南竿鄉", 26.1500, 119.9333,
  "連江縣", "北竿鄉", 26.2167, 119.9833,
  "連江縣", "莒光鄉", 25.9667, 119.9333,
  "連江縣", "東引鄉", 26.3667, 120.4833
)

# 加入合併欄位
taiwan_district_coords <- taiwan_district_coords %>%
  mutate(county_district = paste0(county, district))

cat("座標表載入:", nrow(taiwan_district_coords), "個鄉鎮市區\n")

# ============================================================================
# PART 3: 地址解析 - 提取縣市與鄉鎮市區
# ============================================================================

cat("PART 3: 地址解析\n")

# 標準化並解析地址
traffic_data <- traffic_data %>%
  mutate(
    # 標準化地址 (台 -> 臺)
    address_clean = str_replace_all(發生地點, "台", "臺"),
    
    # 提取縣市
    county = case_when(
      str_detect(address_clean, "臺北市") ~ "臺北市",
      str_detect(address_clean, "新北市") ~ "新北市",
      str_detect(address_clean, "桃園市|桃園縣") ~ "桃園市",
      str_detect(address_clean, "臺中市|臺中縣") ~ "臺中市",
      str_detect(address_clean, "臺南市|臺南縣") ~ "臺南市",
      str_detect(address_clean, "高雄市|高雄縣") ~ "高雄市",
      str_detect(address_clean, "基隆市") ~ "基隆市",
      str_detect(address_clean, "新竹市") ~ "新竹市",
      str_detect(address_clean, "新竹縣") ~ "新竹縣",
      str_detect(address_clean, "苗栗縣") ~ "苗栗縣",
      str_detect(address_clean, "彰化縣") ~ "彰化縣",
      str_detect(address_clean, "南投縣") ~ "南投縣",
      str_detect(address_clean, "雲林縣") ~ "雲林縣",
      str_detect(address_clean, "嘉義市") ~ "嘉義市",
      str_detect(address_clean, "嘉義縣") ~ "嘉義縣",
      str_detect(address_clean, "屏東縣") ~ "屏東縣",
      str_detect(address_clean, "宜蘭縣") ~ "宜蘭縣",
      str_detect(address_clean, "花蓮縣") ~ "花蓮縣",
      str_detect(address_clean, "臺東縣") ~ "臺東縣",
      str_detect(address_clean, "澎湖縣") ~ "澎湖縣",
      str_detect(address_clean, "金門縣") ~ "金門縣",
      str_detect(address_clean, "連江縣") ~ "連江縣",
      TRUE ~ NA_character_
    ),
    
    # 提取鄉鎮市區
    district = str_extract(address_clean, "(?<=[市縣])[^市縣路街巷弄號樓]{1,4}[區鄉鎮市]"),
    
    # 合併
    county_district = paste0(county, district)
  )

# 解析結果統計
cat("\n【縣市解析結果】\n")
print(table(traffic_data$county, useNA = "ifany") %>% sort(decreasing = TRUE))

cat("\n【鄉鎮市區 Top 20】\n")
print(table(traffic_data$county_district, useNA = "ifany") %>% sort(decreasing = TRUE) %>% head(20))

success_rate <- mean(!is.na(traffic_data$county) & !is.na(traffic_data$district)) * 100
cat("\n地址解析成功率:", round(success_rate, 2), "%\n")

# ============================================================================
# PART 4: 合併座標
# ============================================================================

cat("PART 4: 合併座標\n")

traffic_data <- traffic_data %>%
  left_join(
    taiwan_district_coords %>% dplyr::select(county_district, lat, lng),
    by = "county_district"
  )

matched <- sum(!is.na(traffic_data$lat))
total <- nrow(traffic_data)
cat("座標匹配成功:", matched, "/", total, "(", round(matched/total*100, 2), "%)\n")

# ============================================================================
# PART 5: 處理死亡受傷人數
# ============================================================================

cat("PART 5: 處理死亡受傷人數\n")

traffic_data <- traffic_data %>%
  mutate(
    death_count = case_when(
      str_detect(死亡受傷人數, "死亡") ~ as.numeric(str_extract(str_extract(死亡受傷人數, "死亡\\d+"), "\\d+")),
      TRUE ~ 0
    ),
    injured_count = case_when(
      str_detect(死亡受傷人數, "受傷") ~ as.numeric(str_extract(str_extract(死亡受傷人數, "受傷\\d+"), "\\d+")),
      TRUE ~ 0
    ),
    total_casualties = death_count + injured_count
  )

# 處理 NA
traffic_data$death_count[is.na(traffic_data$death_count)] <- 0
traffic_data$injured_count[is.na(traffic_data$injured_count)] <- 0
traffic_data$total_casualties <- traffic_data$death_count + traffic_data$injured_count

cat("死亡人數統計:\n")
print(summary(traffic_data$death_count))

# ============================================================================
# PART 6: 處理車種
# ============================================================================

cat("PART 6: 處理車種\n")

traffic_data <- traffic_data %>%
  mutate(
    has_passenger_car = ifelse(str_detect(車種, "小客|轎車|休旅|SUV"), 1, 0),
    has_motorcycle = ifelse(str_detect(車種, "機車|電動機|重機"), 1, 0),
    has_truck = ifelse(str_detect(車種, "大貨|貨車|卡車"), 1, 0),
    has_bus = ifelse(str_detect(車種, "公車|客車|遊覽|巴士"), 1, 0),
    has_small_truck = ifelse(str_detect(車種, "小貨"), 1, 0),
    has_taxi = ifelse(str_detect(車種, "計程|出租"), 1, 0),
    has_non_motor = ifelse(str_detect(車種, "人|自行車"), 1, 0),
    has_other = ifelse(!(has_passenger_car | has_motorcycle | has_truck | has_bus | 
                           has_small_truck | has_taxi | has_non_motor), 1, 0),
    vehicle_count = has_passenger_car + has_motorcycle + has_truck + 
      has_bus + has_small_truck + has_taxi + has_non_motor + has_other,
    is_multi_vehicle = ifelse(vehicle_count >= 2, 1, 0)
  )

cat("✓ 車種處理完成\n")

# ============================================================================
# PART 7: 新增衍生變數
# ============================================================================

cat("PART 7: 新增衍生變數\n")

traffic_data <- traffic_data %>%
  mutate(
    incident_type = case_when(
      death_count > 0 ~ "A1",
      injured_count > 0 ~ "A2",
      TRUE ~ NA_character_
    ),
    season = case_when(
      month %in% c(12, 1, 2) ~ "冬季",
      month %in% c(3, 4, 5) ~ "春季",
      month %in% c(6, 7, 8) ~ "夏季",
      month %in% c(9, 10, 11) ~ "秋季"
    ),
    month_name = month.abb[month]
  )

cat("✓ 衍生變數建立完成\n")

# ============================================================================
# PART 8: 鄉鎮市區統計彙整
# ============================================================================

cat("PART 8: 鄉鎮市區統計彙整\n")

district_stats <- traffic_data %>%
  filter(!is.na(lat)) %>%
  group_by(county, district, county_district, lat, lng) %>%
  summarise(
    total_incidents = n(),
    total_deaths = sum(death_count, na.rm = TRUE),
    total_injured = sum(injured_count, na.rm = TRUE),
    total_casualties = sum(total_casualties, na.rm = TRUE),
    a1_count = sum(incident_type == "A1", na.rm = TRUE),
    a2_count = sum(incident_type == "A2", na.rm = TRUE),
    motorcycle_count = sum(has_motorcycle, na.rm = TRUE),
    car_count = sum(has_passenger_car, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    death_rate = round(total_deaths / total_incidents * 1000, 2),
    a1_rate = round(a1_count / total_incidents * 100, 2),
    motorcycle_rate = round(motorcycle_count / total_incidents * 100, 2)
  ) %>%
  arrange(desc(total_incidents))

cat("統計完成:", nrow(district_stats), "個鄉鎮市區\n")

cat("\n【事故熱點 Top 20】\n")
print(head(district_stats %>% dplyr::select(county_district, total_incidents, total_deaths, death_rate), 20))

cat("\n【死亡率最高 Top 20】(至少100件事故)\n")
print(district_stats %>% 
        filter(total_incidents >= 100) %>% 
        arrange(desc(death_rate)) %>% 
        dplyr::select(county_district, total_incidents, total_deaths, death_rate) %>%
        head(20))

# ============================================================================
# PART 9: K-means 聚類分析
# ============================================================================

cat("PART 9: K-means 聚類分析\n")

# 選擇聚類變數
cluster_vars <- district_stats %>%
  filter(total_incidents >= 50) %>%  # 至少50件事故
  dplyr::select(total_incidents, total_deaths, death_rate, a1_rate, motorcycle_rate)

# 標準化
cluster_scaled <- scale(cluster_vars)
rownames(cluster_scaled) <- district_stats$county_district[district_stats$total_incidents >= 50]

# Elbow Method
wss <- sapply(1:8, function(k) {
  kmeans(cluster_scaled, k, nstart = 25)$tot.withinss
})

# Elbow 圖
elbow_df <- data.frame(k = 1:8, wss = wss)
p_elbow <- ggplot(elbow_df, aes(x = k, y = wss)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(size = 3, color = "steelblue") +
  geom_vline(xintercept = 3, linetype = "dashed", color = "red") +
  labs(title = "Elbow Method - 最佳群數選擇",
       x = "群數 (k)", y = "WSS") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p_elbow)

# K-means (k=3)
set.seed(2025)
km_result <- kmeans(cluster_scaled, centers = 3, nstart = 25)

# 加入聚類結果
district_stats_cluster <- district_stats %>%
  filter(total_incidents >= 50) %>%
  mutate(cluster = factor(km_result$cluster))

cat("\n【聚類結果】\n")
print(table(district_stats_cluster$cluster))

# 各群特徵
cat("\n【各群特徵】\n")
cluster_summary <- district_stats_cluster %>%
  group_by(cluster) %>%
  summarise(
    區數 = n(),
    平均事故數 = round(mean(total_incidents)),
    平均死亡數 = round(mean(total_deaths), 1),
    平均死亡率 = round(mean(death_rate), 2),
    平均A1比率 = round(mean(a1_rate), 2),
    .groups = "drop"
  )
print(cluster_summary)

# 聚類視覺化
p_cluster <- fviz_cluster(km_result, data = cluster_scaled,
                          palette = c("#E41A1C", "#377EB8", "#4DAF4A"),
                          geom = "point",
                          ellipse.type = "convex",
                          ggtheme = theme_minimal()) +
  labs(title = "鄉鎮市區風險聚類 (K-means, k=3)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p_cluster)

# ============================================================================
# PART 10: 靜態熱點地圖
# ============================================================================

cat("PART 10: 靜態熱點地圖\n")

# 事故數量熱點圖
p_hotspot <- ggplot(district_stats, aes(x = lng, y = lat)) +
  geom_point(aes(size = total_incidents, color = total_incidents), alpha = 0.6) +
  scale_size_continuous(range = c(1, 15), name = "事故數") +
  scale_color_viridis_c(option = "plasma", name = "事故數") +
  labs(title = "台灣交通事故熱點圖 (鄉鎮市區)",
       subtitle = "2013-2019年",
       x = "經度", y = "緯度") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14))
print(p_hotspot)

# 死亡率熱點圖
p_death <- ggplot(district_stats %>% filter(total_incidents >= 100), 
                  aes(x = lng, y = lat)) +
  geom_point(aes(size = total_incidents, color = death_rate), alpha = 0.6) +
  scale_size_continuous(range = c(2, 12), name = "事故數") +
  scale_color_gradient(low = "yellow", high = "red", name = "死亡率\n(每千件)") +
  labs(title = "台灣交通事故死亡率分布",
       subtitle = "僅顯示事故數 ≥ 100 的區域",
       x = "經度", y = "緯度") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14))
print(p_death)

# ============================================================================
# PART 11: 互動式地圖 (Leaflet)
# ============================================================================

cat("PART 11: 互動式地圖 (Leaflet)\n")

# 顏色設定
pal_incidents <- colorNumeric(palette = "YlOrRd", domain = district_stats$total_incidents)
pal_death <- colorNumeric(palette = "Reds", domain = district_stats$death_rate)
pal_cluster <- colorFactor(
  palette = c("#E41A1C", "#377EB8", "#4DAF4A"), 
  domain = district_stats_cluster$cluster
)

# 11.1 事故數量互動地圖
map_incidents <- leaflet(district_stats) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = 120.9, lat = 23.7, zoom = 7) %>%
  addCircleMarkers(
    ~lng, ~lat,
    radius = ~sqrt(total_incidents) / 4,
    color = ~pal_incidents(total_incidents),
    fillOpacity = 0.7,
    stroke = TRUE, weight = 1,
    popup = ~paste0(
      "<b>", county_district, "</b><br>",
      "事故數: ", format(total_incidents, big.mark = ","), "<br>",
      "死亡數: ", total_deaths, "<br>",
      "受傷數: ", format(total_injured, big.mark = ","), "<br>",
      "死亡率: ", death_rate, " (每千件)<br>",
      "A1比率: ", a1_rate, "%"
    )
  ) %>%
  addLegend("bottomright", pal = pal_incidents, values = ~total_incidents, 
            title = "事故數量", opacity = 0.7)

print(map_incidents)
cat("✓ 事故數量地圖\n")

# 11.2 死亡率互動地圖
map_death <- leaflet(district_stats %>% filter(total_incidents >= 50)) %>%
  addProviderTiles(providers$CartoDB.VoyagerLabelsUnder) %>%
  setView(lng = 120.9, lat = 23.7, zoom = 7) %>%
  addCircleMarkers(
    ~lng, ~lat,
    radius = ~sqrt(total_incidents) / 4,
    color = ~pal_death(death_rate),
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0(
      "<b>", county_district, "</b><br>",
      "死亡率: ", death_rate, " (每千件)<br>",
      "事故數: ", format(total_incidents, big.mark = ","), "<br>",
      "死亡數: ", total_deaths
    )
  ) %>%
  addLegend("bottomright", pal = pal_death, values = ~death_rate, 
            title = "死亡率", opacity = 0.7)
print(map_death)
cat("✓ 死亡率地圖\n")

# 11.3 聚類互動地圖
map_cluster <- leaflet(district_stats_cluster) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = 120.9, lat = 23.7, zoom = 7) %>%
  addCircleMarkers(
    ~lng, ~lat,
    radius = ~sqrt(total_incidents) / 4,
    color = ~pal_cluster(cluster),
    fillOpacity = 0.7,
    stroke = TRUE, weight = 1,
    popup = ~paste0(
      "<b>", county_district, "</b><br>",
      "風險群組: ", cluster, "<br>",
      "事故數: ", format(total_incidents, big.mark = ","), "<br>",
      "死亡率: ", death_rate, " (每千件)"
    )
  ) %>%
  addLegend("bottomright", pal = pal_cluster, values = ~cluster, 
            title = "風險群組", opacity = 0.7)
print(map_cluster)
cat("✓ 聚類地圖\n")
